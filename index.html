<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>Zoomlinks</title>
    <script src="js/jquery-1.8.3.min.js"></script>
    <script>
        console.log('HotKey start');
        console.log(window.localStorage.username);
        window.addEventListener("load", setupConnection, false);

        window.addEventListener("load", function(){
         var theButton;
         var ToolbarUIItemProperties = {
             title: "Zoomlinks",
             icon: "img/icon48.png",
             popup: {
                 href: "popup.html",
                 width: 350,
                 height: 350
                 }
             }
             theButton = opera.contexts.toolbar.createItem(ToolbarUIItemProperties);
             opera.contexts.toolbar.addItem(theButton);
         }, false);


        function setupConnection(){
            opera.extension.onconnect = function(event){
                event.source.postMessage("something")
            }

            opera.extension.onmessage = function(event){

                var focused = opera.extension.tabs.getSelected();

                var username = window.localStorage.username;
                var password = window.localStorage.password;
                var defaultFolder = 0;

                var xhrCheckAuth = new XMLHttpRequest();
                xhrCheckAuth.open('GET','http://zoomlinks.ru/authApi/checkAuth');
                xhrCheckAuth.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhrCheckAuth.send();
                xhrCheckAuth.addEventListener('load', function(event) {
                    var responseObj = jQuery.parseJSON(xhrCheckAuth.responseText);
                    if (responseObj.isAuthenticated == false){

                        msgSingIn = "username=" + username + "&password=" + password;
                        var xhrSingIn = new XMLHttpRequest();
                        xhrSingIn.open('POST','http://zoomlinks.ru/authApi/signIn');
                        xhrSingIn.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                        xhrSingIn.send(msgSingIn);
                        xhrSingIn.addEventListener('load', function(event) {

                            var responseAuthObj = jQuery.parseJSON(xhrSingIn.responseText)
                            if (responseAuthObj.isAuthenticated == true){
                                addLink(focused.url,defaultFolder);
                            }

                        }, false);

                    }else{
                        addLink(focused.url,defaultFolder);
                    }

                }, false);

            }
        }

        function addLink(url,folder){

                var msg = "url="+url+"&folder="+folder;
                var xhr = new XMLHttpRequest();
                xhr.open('POST','http://zoomlinks.ru/rest/link');
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr.send(msg);
                xhr.addEventListener('load', function(event) {
                    console.log('responseText = ' + xhr.responseText)

                }, false);
        }

    </script>
</head>
<body>

</body>
</html>
