<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>Zoomlinks</title>
    <script src="js/jquery-1.8.3.min.js"></script>
    <script>
        console.log('HotKey start');

        window.addEventListener("load", setupConnection, false);

        window.addEventListener("load", function(){
         var theButton;
         var ToolbarUIItemProperties = {
             title: "Zoomlinks",
             icon: "img/icon48.png",
             popup: {
                 href: "popup.html",
                 width: 350,
                 height: 350
                 }
             }
             theButton = opera.contexts.toolbar.createItem(ToolbarUIItemProperties);
             opera.contexts.toolbar.addItem(theButton);
         }, false);


        function setupConnection(){
            opera.extension.onconnect = function(event){
                event.source.postMessage("something")
            }

            opera.extension.onmessage = function(event){

                var focused = opera.extension.tabs.getSelected();
                console.log('Key ='+event.data+' tab url = '+focused.url);
                addLink(focused.url,0);
                /*$.post("http://zoomlinks.ru/rest/link", { url: focused.url, folder: 0 }).done(function(data) {
                        console.log('send post = ok');
                    }).fail(function(data){
                        console.log('send post = fail');
                    });*/

            }
        }

        function addLink(url,folder){
            console.log('start send xhr');
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if(xhr.readyState == 4) {
                    clearTimeout(xhrTimeout);
                    if (xhr.status == 200) {
                        console.log('send xhr = ok');
                    }
                }
            }
            xhr.open("POST", "http://zoomlinks.ru/rest/link", true);
            xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=utf-8");
            xhr.send("url="+url+"&folder="+folder);
            var xhrTimeout = setTimeout("xhr.abort();aborted('addLink');console.log('send xhr = fail');", 5000);
        }
    </script>
</head>
<body>

</body>
</html>
